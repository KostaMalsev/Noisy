
<!doctype html>
<html>
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 
</head>

<body>

<script>

let audioCtx;
let analyserNode;
let bufferLength;
let dataArray;
let audioSourceNode;
let stream;

//Get the mic  persmissions:
    const gotUserMedia = function(localMediaStream) {

      console.log('success grabbing microphone');

      stream = localMediaStream;

      audioCtx = new AudioContext;

      audioSourceNode = audioCtx.createMediaStreamSource(stream);

      //Init the worker:
      //initAudioProcess();

      // Creates a processig pipeline:
      //createPipeline();
      //Create analyser node
       analyserNode = audioCtx.createAnalyser();
       analyserNode.fftSize = 1024;//256;
       bufferLength = analyserNode.frequencyBinCount;
       dataArray = new Float32Array(bufferLength);

      //Set up audio node network
      audioSourceNode.connect(analyserNode);
      analyserNode.connect(audioCtx.destination);


    }


    const userMediaFailed = function(e) {
      console.log(e);
    }


    // Get the user media:
    navigator.getUserMedia({
      video: false,
      //audio: true,
      audio: {
          autoGainControl: false,
          channelCount: 2,
          echoCancellation: false,
          noiseSuppression: false
          },

    }, gotUserMedia, userMediaFailed);


//const audioCtx = new AudioContext();

//Create audio source
//Here, we use an audio file, but this could also be e.g. microphone input
//const audioEle = new Audio();


//audioEle.src = 'my-audio.mp3';//insert file name here

//audioEle.autoplay = true;
//audioEle.preload = 'auto';
//const audioSourceNode = audioCtx.createMediaElementSource(audioEle);


//Create 2D canvas
const canvas = document.createElement('canvas');
canvas.style.position = 'absolute';
canvas.style.top = 0;
canvas.style.left = 0;
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
document.body.appendChild(canvas);
const canvasCtx = canvas.getContext('2d');
canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

function draw() {
  //Schedule next redraw
  requestAnimationFrame(draw);

  if(typeof('dataArray')=='undefined')return;
  //Get spectrum data
  analyserNode.getFloatFrequencyData(dataArray);

  //Draw black background
  canvasCtx.fillStyle = 'rgb(0, 0, 0)';
  canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

  //Draw spectrum
  const barWidth = (canvas.width / bufferLength) * 2.5;
  let posX = 0;
  for (let i = 0; i < bufferLength; i++) {
    const barHeight = (dataArray[i] + 140) * 2;
    canvasCtx.fillStyle = 'rgb(' + Math.floor(barHeight + 100) + ', 50, 50)';
    canvasCtx.fillRect(posX, canvas.height - barHeight / 2, barWidth, barHeight / 2);
    posX += barWidth + 1;
  }
}

draw();

</script>
</body>
</html>

